      PROGRAM NSTOKES
      IMPLICIT REAL*8 (A-H,O-Z)
	DIMENSION FI(400),AL(400),AG(400,600)
	CHARACTER*20 FI_GRID,FI_DAT,FI_MOD,FI_OUT
	DATA R,RO,G,GE/6371000.D0,2.67d0,6.6272d-8,9.7803267715d5/

	OPEN(0, FILE='STOKES0.IN',STATUS='OLD')
	READ(0,*)FI_GRID
	READ(0,*)FI_DAT
	READ(0,*)FI_MOD
	READ(0,*)FI_OUT
	READ(0,*)DLAT,DLON
      READ(0,*)NL,NC,R1,R2
	CLOSE(0)

      OPEN(1,FILE=FI_GRID,STATUS='OLD')
      DO I=1,NL
       DO J=1,NC
c         READ(1,*) N,FI(I),AL(J),AG(I,J)
         READ(1,*) AL(J),FI(I),AG(I,J)
       ENDDO
      ENDDO
      CLOSE(1)

	PI=DACOS(-1.D0)
	DD=DLAT*DLON*(PI/180.D0)**2.D0
      !RAIO DA ZONA INTERIOR
	PSI0=R1*DSQRT(DD)
      !RAIO DA ZONA EXTERIOR
	PSI1=R2*DSQRT(DD)


      OPEN(2,FILE=FI_DAT,STATUS='OLD')
	OPEN(3,FILE=FI_MOD,STATUS='OLD')
	OPEN(4,FILE=FI_OUT,STATUS='UNKNOWN')
	IEOF=1

      DO WHILE (IEOF.EQ.1)
	  READ(2,*,END=100)NP,ALAT,ALON,HP,ANOM
	  READ(3,*,END=100)INT,REL1,REL2,EGM

	  SFI=DSIND(ALAT)
	  CFI=DCOSD(ALAT)
        GAMA=GE*(1.d0+5.2790414D-3*(DSIND(ALAT*PI/180))**2)

      ! CÁLCULO DA ONDULAÇÃO NA ZONA INTERIOR DE RAIO PSI_0 JUNTO AO PONTO (H&M 2-234)
	  SUM=(PSI0*R)*ANOM/GAMA
	  I=0
	  DO K=1,NL
	   DO L=1,NC

	     PSI=SFI*DSIND(FI(K))
     1        +CFI*DCOSD(FI(K))*DCOSD(AL(L)-ALON)
	     PSI=DACOS(PSI)
	    IF (PSI.GT.PSI0 .AND. PSI.LT.PSI1) THEN
        !CALCULO DA FUNÇÃO DE STOKES COM COORDENADAS GEODÉSICAS
	     SP2=DSIN(PSI/2.D0)
	     CP=DCOS(PSI)
	     S_PSI=1.D0/SP2-6.D0*SP2+1.D0-5.D0*CP-3.D0*CP*DLOG(SP2+SP2**2)
        !TERMO GERAL DO INTEGRAL DE STOKES
           SUM=SUM+AG(K,L)*CFI*S_PSI*DD
	     I=I+1
	    ENDIF

	   ENDDO
	  ENDDO
	  
C EFEITO INDIRECTO
        IF (HP.GT.0.D0) THEN
	   EF=PI*G*RO*HP**2/(GAMA*1.D-5)
	  ELSE
 	   EF=0.D0
	  ENDIF
C        EF=0.D0
	  RES=R*SUM/(4.D0*PI*GAMA)+EF
	  OND=EGM+RES
	  WRITE(4,10) NP,ALAT,ALON,OND,RES

      ENDDO

100   CLOSE(2)
	CLOSE(3)
	CLOSE(4)
10    FORMAT(I10,2F12.5,2F10.2)

      END



