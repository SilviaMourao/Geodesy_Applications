	PROGRAM GSI
	IMPLICIT REAL*8 (A-H,O-Z)
	CHARACTER*12 F1,F2,F3
	DIMENSION IVIS(2,20),IV(20),OBSD(20,3),OBSI(20,3)
	DATA RK,POB/1.D0,1.D0/
      
	OPEN(0,FILE='GSI06.IN',STATUS='OLD')
	READ(0,*)F1
	READ(0,*)F2
	READ(0,*)F3
	READ(0,*) S0,AA,BB
	S20=S0*S0
	AA=AA*1D-3
	BB=BB*1D-6
C ITYPE- TIPO DE GSI, GSI8 E GSI16
C IMODE- MODO DE OBSERVAÇÕES, 1= ENCRUZADAS, 2= COJUGADAS
      READ(0,*) ITYPE
	READ(0,*) NG
	DO I=1,NG
	 READ(0,*) IVIS(1,I),IVIS(2,I)
	ENDDO
	CLOSE(0)

	OPEN (1, FILE=F1, STATUS='OLD')
	OPEN (2, FILE=F2)
	OPEN (3, FILE=F3)
	OPEN (4, FILE='ERROS.TXT')

	DO J=1,NG
	 DO K=1,IVIS(2,J)
	  IF (ITYPE.EQ.8) THEN
	   READ(1,100) IV(K),iun,IG1,IM1,IS1,iun,IG2,IM2,IS2,IDIST
	  ELSE
	   READ(1,101) IV(K),iun,IG1,IM1,IS1,iun,IG2,IM2,IS2,IDIST
	  ENDIF
C CONVERSÃO DOS ÂNGULOS EM FUNÇÃO DA UNIDADE
	  if (iun.eq.324) then
	   OBSD(K,1)=IG1+IM1/60.D0+(IS1/10)/3600.D0
	   OBSD(K,2)=IG2+IM2/60.D0+(IS2/10)/3600.D0
	  else
	   OBSD(K,1)=(IG1+IM1/100.D0+IS1/100000.D0)*180/200
	   OBSD(K,2)=(IG2+IM2/100.D0+IS2/100000.D0)*180/200
	  endif
	  OBSD(K,3)=IDIST/1.D4
	 ENDDO

	 DO k=IVIS(2,J),1,-1
	  IF (ITYPE.EQ.8) THEN
	   READ(1,100) IV(K),iun,IG1,IM1,IS1,iun,IG2,IM2,IS2,IDIST
	  ELSE
	   READ(1,101) IV(K),iun,IG1,IM1,IS1,iun,IG2,IM2,IS2,IDIST
	  ENDIF
C CONVERSÃO DOS ÂNGULOS EM FUNÇÃO DA UNIDADE
	  if (iun.eq.324) then
	   OBSI(K,1)=IG1+IM1/60.D0+(IS1/10)/3600.D0
	   OBSI(K,2)=IG2+IM2/60.D0+(IS2/10)/3600.D0
	  else
	   OBSI(K,1)=(IG1+IM1/100.D0+(IS1/10)/10000.D0)*180/200
	   OBSI(K,2)=(IG2+IM2/100.D0+(IS2/10)/10000.D0)*180/200
	  endif
	  OBSI(K,3)=IDIST/1.D4
	 ENDDO

	 DO K=1,IVIS(2,J)
	  IF (OBSD(K,1).GT.OBSI(K,1)) THEN
	   DAZ=(OBSD(K,1)+OBSI(K,1)+180.D0)/2.D0
	  ELSE 
	   DAZ=(OBSD(K,1)+OBSI(K,1)-180.D0)/2.D0
	  ENDIF
	  IF (ABS(OBSD(K,1)-OBSI(K,1)).GT.270) THEN
	   DAZ=(OBSD(K,1)+OBSI(K,1)+180.D0)/2.D0
	  ENDIF
	  IF (DAZ.LT.0.D0) DAZ=DAZ+360.D0

	  DZ=(OBSD(K,2)+(360.D0-OBSI(K,2)))/2.D0

C CONSTANTE DO PRISMA (8mm PARA O MINI-PRISMA DA TOPOMETRICA)
	  IF (IV(K).GT.9 .AND. IV(K).LT.99) C=8.D-3

	  DIST1=(OBSD(K,3)+C)*DSIND(OBSD(K,2))
	  DIST2=(OBSI(K,3)+C)*ABS(DSIND(OBSI(K,2)))
	  DIST=(DIST1+DIST2)/2.D0
	  S2D=RK*(AA**2.D0+(BB*DIST)**2.D0)
	  PD=S20/S2D

        ecol=(obsd(k,1)-(obsi(k,1)-180.d0))/2*3600
	  if (ecol.gt.600000) ecol=ecol-648000
	  eidx=(obsd(k,2)-(360.d0-obsi(k,2)))/2*3600


	  CALL DMS(DAZ,IG,IM,SS)

	  WRITE(2,200) IVIS(1,J),IV(K), IG,IM,SS, POB
	  WRITE(3,201) IVIS(1,J),IV(K), DIST, PD
	  WRITE(4,202) IVIS(1,J),IV(K), ecol,eidx
	 ENDDO
	ENDDO
100   FORMAT(12X,I3,2(4X,I3,1X,I3,I2,I3),8X,I8)
101   FORMAT(21X,I3,2(4X,I3,9X,I3,I2,I3),16X,I8)
200   FORMAT(2(I3,2X),I3,1X,I2,1X,F4.1,F5.1)
201   FORMAT(2(I3,2X),F10.4,F12.1)
202   FORMAT(2(I3,2X),2F10.1)
	
      DO I=1,3 
	 CLOSE(I)
	ENDDO
	END

	SUBROUTINE DMS(ANG,IG,IM,SS)
	IMPLICIT REAL*8 (A-H,O-Z)
      IG=INT(ANG)
	IM=INT((ANG-IG)*6.D1)
	SS=((ANG-IG)*6.D1-IM)*6.D1
	RETURN
      END
